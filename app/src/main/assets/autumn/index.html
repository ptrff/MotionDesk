<!--
	Created by No_name
	Steam: steamcommunity.com/profiles/76561198338169821
	Source based on OutsideOfSociety's experiment.
	2022
-->
<!doctype html>
<html lang="en">

<head>
	<title>Autumn</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<style type="text/css">
		html,
		body {
			background: #535353;
			height: 100%;
			width: 100%;
			padding: 0;
			margin: 0;
			overflow: hidden;
		}
		#info{
			position: fixed;
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
		}
		#info>span{
			color: white;
			text-shadow: black 2px 1px 2px;
			opacity: 0;
			font-size: 44px;
			font-family: Arial;
		}
		#info>span.show{
			animation: vis 2s;
		}
		@keyframes vis {
  			from {opacity: 1;}
  			to {opacity: 0;}
		}
	</style>
</head>

<body>
	<div id="info"><span></span></div>
	<script src="three.min.js"></script>
	<!--<script src="tween.min.js"></script>-->

	<script src="js/shaders/CopyShader.js"></script>
	<script src="js/shaders/ConvolutionShader.js"></script>
	<script src="js/shaders/RadialBlurShader.js"></script>
	<script src="js/shaders/LensflareShader.js"></script>

	<script src="js/postprocessing/EffectComposer.js"></script>
	<script src="js/postprocessing/MaskPass.js"></script>
	<script src="js/postprocessing/RenderPass.js"></script>
	<script src="js/postprocessing/ShaderPass.js"></script>
	<script src="js/postprocessing/BloomPass.js"></script>

	<script>
		var animationFrame;
		function frame() {
		  animationFrame = requestAnimationFrame(frame);



		  // Let the host app know
		  window.androidWallpaperInterface.drawFrame();
		}

		function pauseWallpaper() {
		  cancelAnimationFrame(animationFrame);
		}

		function resumeWallpaper() {
		  frame();
		}

		frame();
	</script>

	<script id="vs" type="x-shader/x-vertex">

			uniform float globalTime;

			attribute vec3 direction;
			attribute float size;
			attribute float seed;
			attribute float time;
			attribute vec3 customColor;
			
			varying vec2 vUv;
			varying vec3 vColor;
			varying vec3 vNormal;
			varying float vSeed;
			varying float vDarken;

			void main() {

				vColor = customColor;
				vSeed = seed;

				vec3 animated = position;

				// time
				float localTime = time + globalTime*(0.5+seed);
				float modTime = mod( localTime, 1.0 );
				float accTime = modTime * modTime;

				animated.z = accTime*11000.0;

				float rotation = localTime*40.0;
				if (seed < 0.5) {
					rotation *= -1.0;
				}

				float s = sin(rotation);
				float c = cos(rotation);

				mat3 rotX = mat3(
			        vec3( 1.0, 0.0,0.0),
			        vec3( 0.0, c,  s),
			        vec3( 0.0,-s,  c)
			    );

				mat3 rotZ = mat3(
			        vec3( c,  s,  0.0),
			        vec3(-s,  c,  0.0),
			        vec3( 0.0,0.0,1.0)
			    );


				vec3 dd = direction;
				dd.y *= sin(rotation);

				vec3 rotatedDirection = dd*(rotZ*rotX);

				vNormal = normal*(rotZ*rotX);

                animated += rotatedDirection*size;

                vDarken = 1.0 - length(vec2(animated.x, animated.y))/7000.0;

				vUv = uv;

				vec4 mvPosition = modelViewMatrix * vec4( animated, 1.0 );

				gl_Position = projectionMatrix * mvPosition;

			}

		</script>

	<script id="fs" type="x-shader/x-fragment">

			uniform sampler2D map;
			uniform sampler2D map2;

			uniform vec3 fogColor;
			uniform float fogNear;
			uniform float fogFar;

			varying vec2 vUv;
			varying vec3 vColor;
			varying vec3 vNormal;

			uniform float globalTime;
			varying float vSeed;
			uniform float black;
			varying float vDarken;
			uniform vec2 lightPos;


			void main() {

				float depth = gl_FragCoord.z / gl_FragCoord.w;
				float fogFactor = smoothstep( fogNear, fogFar, depth );

				vec4 tex = vec4(0.0);

				if (vSeed > 0.5) {
					tex = texture2D( map2, vUv );
				} else {
					tex = texture2D( map, vUv );
				}

				float tres = 0.01;

				if (black > 0.5) {
					tres = 0.8;
				}

				if (tex.w <= tres) {
					discard;
				}

				// light
				vec3 light = vec3(lightPos.x,lightPos.y, -0.8);
				float d = pow(max(0.01,dot(vNormal.xyz, light))*1.5, 1.0);
				float d2 = pow(max(0.05,dot(-vNormal.xyz, light))*1.5, 1.0);

				float t = globalTime;

				gl_FragColor = vec4( mix( (tex.xyz*vColor*(d))*black*vDarken, fogColor, fogFactor ), tex.w);

				if (black > 0.5) {
					gl_FragColor.w *= pow( gl_FragCoord.z, 20.0 );
				}

			}

		</script>


	<script id="vs_tree" type="x-shader/x-vertex">

			uniform float globalTime;
			
			varying vec2 vUv;
			varying vec3 vNormal;
			varying float vDarken;

			void main() {

				vUv = uv;
				vNormal = normal;

				vDarken = 1.25-max( 0.25, (position.z+30.0)/10.0 );

				vec3 animated = position;

				animated.x += sin(position.y*0.04+globalTime)*1.0;
				animated.y += cos(position.x*0.03+globalTime)*1.0;
				animated.z += cos(position.z*0.02+globalTime)*1.0;

				vec4 mvPosition = modelViewMatrix * vec4( animated, 1.0 );

				gl_Position = projectionMatrix * mvPosition;

			}

		</script>

	<script id="fs_tree" type="x-shader/x-fragment">

			uniform sampler2D map;
			uniform vec3 color;
			uniform vec2 lightPos;

			varying vec2 vUv;
			varying vec3 vNormal;
			varying float vDarken;

			uniform sampler2D shadow;
			uniform float globalTime;


			void main() {

				vec4 tex = texture2D( map, vUv );

				if (tex.w <= 0.99) {
					discard;
				}

				vec2 sUv = vec2(vUv.x-sin(vUv.x*0.3+globalTime)*0.15, vUv.y-cos(vUv.y*0.3+globalTime)*0.15);

				vec4 shd = texture2D( shadow, sUv*1.5 );
				float shadowAdd = 1.0;

				if (shd.w > 0.5) {
					shadowAdd = shd.z*vDarken;
				}

				// light
				vec3 light = vec3(lightPos.x,lightPos.y, -0.8);
				float d = pow(max(0.35,dot(vNormal.xyz, light))*1.3, 1.3);

				gl_FragColor = vec4( tex.xyz*color*d*shadowAdd*(vDarken), tex.w);

			}

		</script>


	<script type="x-shader/x-vertex" id="p_vs">

			attribute float size;
			attribute float time;
			uniform float globalTime;

			varying float vAlpha;
			varying float vDarken;

			void main() {

				vec3 pos = position; 

				// time
				float localTime = time + globalTime;
				float modTime = mod( localTime, 1.0 );
				float accTime = modTime * modTime;

				pos.x += cos(modTime*32.0 + (position.z))*100.0; 
				pos.y += sin(modTime*24.0 + (position.x))*100.0; 
				pos.z += sin(modTime*24.0 + (position.y))*100.0;

				vec3 animated = vec3( pos.x, pos.y, pos.z );

				vAlpha = sin((globalTime + animated.y*0.025)*0.5);

				vDarken = 1.0 - length(vec2(animated.x, animated.y))/6000.0;

				vec4 mvPosition = modelViewMatrix * vec4( animated, 1.0 );

				gl_PointSize = min(10.0, (size * ( 250.0 / length( mvPosition.xyz ) ) ) );

				gl_Position = projectionMatrix * mvPosition;

			}

		</script>

	<script type="x-shader/x-fragment" id="p_fs">

			uniform vec3 color;
			uniform sampler2D texture;

			varying float vAlpha;
			varying float vDarken;

			void main() {

				vec4 outColor = texture2D( texture, gl_PointCoord );

				gl_FragColor = vec4( outColor.xyz*color*vAlpha, (outColor.w*vAlpha)*0.5 );
				//gl_FragColor *= vDarken;
			}

		</script>


	<script>
		let a=function(){const t=document.querySelector("#info>span");return e=>{t.innerHTML=e;t.classList.remove("show");void t.offsetWidth;t.classList.add("show")}}();a("Loading...");var P={};var r=localStorage.getItem("configs")||null;if(r){r=JSON.parse(r)}let o=null;window.wallpaperPropertyListener={applyUserProperties:function(t){if(Object.keys(t).length>1){if(o){clearTimeout(o)}localStorage.setItem("configs",JSON.stringify(t));r=t;u(r)}else{let e=Object.keys(t)[0];r[e]=t[e];a(`Updating "${t[e].text}" = ${t[e].value}`);if(o){clearTimeout(o)}o=setTimeout(()=>{localStorage.setItem("configs",JSON.stringify(r));window.location.reload()},1e3)}}};if(r){o=setTimeout(()=>{u(r)},1e3)}if(window.location.host==="127.0.0.1:5500"){fetch("./project.json").then(e=>e.json()).then(e=>{u(e.general.properties)})}var x;var C,I,S,b;var F=false;var n;var s;var l;var V;var z;var L;var W;var d=new THREE.Projector;var B=new THREE.Vector3;var c;var G;var j;var k;var N;var U=[];var v=new THREE.Vector2(-.5,.5);var e="ontouchstart"in document||navigator.userAgent.match(/ipad|iphone|android/i)!=null;var O=1;if(e)O=2;var D;var t=0;function u(e){P={trees:{amount:e.treesamount.value,color:e.treescolor.value},leaves:{amount:e.leavesamount.value,speed:e.leavesspeed.value},fireflies:{amount:e.firefliesamount.value,color:e.firefliescolor.value,speed:e.firefliesspeed.value},camera:{height:e.cameraheight.value,type:!!e.cameratype.value},lensflare:{opacity:e.lensflareopacity.value},lensdirt:{opacity:e.lensdirtopacity.value},rays:{opacity:e.raysopacity.value},bloom:{strength:e.bloomstrength.value},mouse:{speed:e.mousespeed.value,sensivity:e.mousesensitivity.value}};m()}function A(){++t;if(t>=7){E()}}function m(){x=document.createElement("div");document.body.appendChild(x);I=new THREE.Scene;C=new THREE.PerspectiveCamera(85,window.innerWidth/window.innerHeight,1,5e4);C.position.y=750;C.position.z=P.camera.height;C.position.x=-750;B.set(0,-750,-1110);C.lookAt(B);I.add(C);k=new THREE.JSONLoader;k.load("Tree_04.js",q);var e=new THREE.Fog(1772546,5e3,12e3);var t=new THREE.MeshBasicMaterial({color:16777215,transparent:true,fog:false,opacity:.25,blending:THREE.AdditiveBlending,map:THREE.ImageUtils.loadTexture("lensflare0.png",undefined,A)});W=new THREE.Mesh(new THREE.PlaneGeometry(10,10),t);var a=5e3;W.scale.set(a,a,a);W.position.set(0,0,-1e4);I.add(W);var r=new THREE.Geometry;var o={direction:{type:"v3",value:new THREE.Vector3(0,0,0)},seed:{type:"f",value:[]},time:{type:"f",value:[]},size:{type:"f",value:[]},customColor:{type:"c",value:new THREE.Color(16777215)}};G={map:{type:"t",value:THREE.ImageUtils.loadTexture("leaf.png",undefined,A)},map2:{type:"t",value:THREE.ImageUtils.loadTexture("leaf2.png",undefined,A)},fogColor:{type:"c",value:e.color},fogNear:{type:"f",value:e.near},fogFar:{type:"f",value:e.far},globalTime:{type:"f",value:0},bass:{type:"f",value:0},black:{type:"f",value:1},lightPos:{type:"v2",value:new THREE.Vector2}};material=new THREE.ShaderMaterial({uniforms:G,attributes:o,vertexShader:document.getElementById("vs").textContent,fragmentShader:document.getElementById("fs").textContent,transparent:true,side:THREE.DoubleSide});var n=new THREE.PlaneGeometry(2,2);THREE.GeometryUtils.triangulateQuads(n);n.applyMatrix((new THREE.Matrix4).makeRotationFromEuler(new THREE.Vector3(-Math.PI/2,0,0)));n.vertices[0].y=.5;n.vertices[3].y=.5;n.computeVertexNormals();n.computeFaceNormals();var s=new THREE.Mesh(n);for(i=0;i<P.leaves.amount;i++){s.position.x=Math.random()*15e3-7500;s.position.y=Math.random()*15e3-7500;s.position.z=0;THREE.GeometryUtils.merge(r,s)}var l=r.vertices;var d=o.direction.value;var v=o.size.value;var u=o.seed.value;var m=o.time.value;var E=o.customColor.value;var c=new THREE.PlaneGeometry(2,2);THREE.GeometryUtils.triangulateQuads(c);c.applyMatrix((new THREE.Matrix4).makeRotationFromEuler(new THREE.Vector3(-Math.PI/2,0,0)));c.applyMatrix((new THREE.Matrix4).setPosition(new THREE.Vector3(1,0,1)));c.vertices[0].y=.5;c.vertices[3].y=.5;for(var p=0;p<l.length;p+=4){d[p]=c.vertices[0];d[p+1]=c.vertices[1];d[p+2]=c.vertices[2];d[p+3]=c.vertices[3];var f=40+Math.random()*100;v[p]=f;v[p+1]=f;v[p+2]=f;v[p+3]=f;var h=Math.random();u[p]=h;u[p+1]=h;u[p+2]=h;u[p+3]=h;var y=Math.random();m[p]=y;m[p+1]=y;m[p+2]=y;m[p+3]=y;var w=new THREE.Color(16777215);w.setHSL(.05+Math.random()*.1,1,.2+Math.random()*.4);E[p]=w;E[p+1]=w;E[p+2]=w;E[p+3]=w}objects=new THREE.Mesh(r,material);objects.position.z=-7500;I.add(objects);var T=new THREE.SpriteMaterial({map:THREE.ImageUtils.loadTexture("lensdirt.jpg",undefined,A),useScreenCoordinates:true,fog:false,opacity:P.lensdirt.opacity});N=new THREE.Sprite(T);N.scale.set(window.innerWidth/O,window.innerHeight/O,1);N.position.set(window.innerWidth/O/2,window.innerHeight/O/2,0);C.add(N);try{S=new THREE.WebGLRenderer({antialias:false});S.setSize(window.innerWidth/O,window.innerHeight/O);S.setClearColor(1380353);S.sortObjects=false;var R={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat};L=new THREE.WebGLRenderTarget(window.innerWidth/O*P.rays.opacity,window.innerHeight/O*P.rays.opacity,R);S.autoClear=false;var H=new THREE.RenderPass(I,C);V=new THREE.ShaderPass(THREE.RadialBlurShader);V.uniforms["tDepth"].value=L;j=new THREE.ShaderPass(THREE.LensflareShader);j.uniforms["pos"].value=new THREE.Vector2(0,.5);j.uniforms["res"].value=new THREE.Vector2(window.innerWidth/O,window.innerHeight/O);j.uniforms["alpha"].value=P.lensflare.opacity;z=new THREE.BloomPass(P.bloom.strength);var g=new THREE.ShaderPass(THREE.CopyShader);g.renderToScreen=true;b=new THREE.EffectComposer(S);b.setSize(window.innerWidth/O,window.innerHeight/O);b.addPass(H);b.addPass(V);b.addPass(j);b.addPass(z);b.addPass(g);x.appendChild(S.domElement);F=true;document.addEventListener("mousemove",Q,false);document.addEventListener("touchmove",X,false);window.addEventListener("resize",_,false);if(O>1){S.domElement.style.webkitTransform="scale3d("+O+", "+O+", 1)";S.domElement.style.webkitTransformOrigin="0 0 0";S.domElement.style.transform="scale3d("+O+", "+O+", 1)";S.domElement.style.transformOrigin="0 0 0";S.domElement.style.position="absolute";S.domElement.style.top="0px";S.domElement.style.left="0px"}x.style.cursor="url(cursor.png),pointer"}catch(M){return}}function p(){var e=document.createElement("canvas");e.width=32;e.height=32;var t=e.getContext("2d");t.fillStyle="#000000";t.fillRect(0,0,32,32);return e}function _(e){var t=window.innerWidth;var a=window.innerHeight;S.setSize(t/O,a/O);C.aspect=t/a;C.updateProjectionMatrix();var r={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBFormat};L=new THREE.WebGLRenderTarget(t/O*P.rays.opacity,t/O*P.rays.opacity,r);V.uniforms["tDepth"].value=L;j.uniforms["res"].value=new THREE.Vector2(t/O,a/O);b.reset();b.setSize(t/O,a/O);if(N){N.scale.set(t/O,a/O,1);N.position.set(t/O/2,a/O/2,0)}}function J(e,t){var a={};var r={color:{type:"c",value:new THREE.Color},map:{type:"t",value:e},shadow:{type:"t",value:t},globalTime:{type:"f",value:0},lightPos:{type:"v2",value:new THREE.Vector2}};var o=new THREE.ShaderMaterial({uniforms:r,attributes:a,vertexShader:document.getElementById("vs_tree").textContent,fragmentShader:document.getElementById("fs_tree").textContent,transparent:true,side:THREE.DoubleSide});return o}function q(e,t){e.applyMatrix((new THREE.Matrix4).makeRotationFromEuler(new THREE.Vector3(-Math.PI/2,0,0)));var a=new THREE.Vector3(0,28,0);for(var r=0;r<e.faces.length;r++){var o=e.faces[r];var n=e.vertices[o.a];var i=e.vertices[o.b];var s=e.vertices[o.c];o.vertexNormals[0]=(new THREE.Vector3).copy(n).sub(a).normalize();o.vertexNormals[1]=(new THREE.Vector3).copy(i).sub(a).normalize();o.vertexNormals[2]=(new THREE.Vector3).copy(s).sub(a).normalize()}var l=THREE.ImageUtils.loadTexture("test4.png",undefined,A);var d=THREE.ImageUtils.loadTexture("test6.png",undefined,A);d.wrapS=THREE.MirroredRepeatWrapping;d.wrapT=THREE.MirroredRepeatWrapping;var v=P.trees.amount;for(var r=0;r<v;r++){var u=J(l,d);var m=new THREE.MeshBasicMaterial({color:131584,side:THREE.DoubleSide});var s=(new THREE.Color).setHSL(.025+P.trees.color*.15+Math.random()*.15,.75,.45);u.uniforms.color.value=s;if(r==0){u.side=THREE.FrontSide}var E=new THREE.MeshFaceMaterial([u,m]);var n=r/v*Math.PI*2;var c=4e3+Math.random()*4e3;var p=new THREE.Mesh(e,E);var f=150+Math.random()*50;p.scale.set(f,150,f);p.position.set(Math.sin(n)*c,Math.cos(n)*c,2500);p.rotation.z=Math.random()*(Math.PI*2);p.seed=Math.random()*v;p.light=true;if(r==0){p.position.set(-9e3,0,-5500);p.rotation.x=2;p.scale.set(200,200,200);p.rotation.y=-Math.PI/2}I.add(p);U.push(p)}var h=new THREE.CylinderGeometry(15e3,15e3,18e3,100,1,true);for(var r=0;r<h.vertices.length;r++){if(h.vertices[r].y>0){h.vertices[r].y+=Math.random()*4e3-2e3}}var y=new THREE.MeshBasicMaterial({color:0,side:THREE.BackSide});var w=new THREE.Mesh(h,y);w.rotation.x=-Math.PI/2;w.position.z=3e3;I.add(w);var T=THREE.ImageUtils.loadTexture("bob.png",undefined,A);var R={size:{type:"f",value:[]},time:{type:"f",value:[]}};uniforms={color:{type:"c",value:new THREE.Color(16777215)},texture:{type:"t",value:T},globalTime:{type:"f",value:0},bass:{type:"f",value:0}};uniforms.color.value.setRGB(...P.fireflies.color.split(" "));var H=new THREE.ShaderMaterial({uniforms:uniforms,attributes:R,vertexShader:document.getElementById("p_vs").textContent,fragmentShader:document.getElementById("p_fs").textContent,transparent:true});var e=new THREE.Geometry;for(r=0;r<P.fireflies.amount;r++){var g=new THREE.Vector3(Math.random()*4e3-2e3,Math.random()*4e3-2e3,Math.random()*-3e3-250);e.vertices.push(g)}D=new THREE.ParticleSystem(e,H);var M=e.vertices;var x=R.size.value;var S=R.time.value;for(var b=0;b<M.length;b++){x[b]=(40+Math.random()*40)/O}D.position.z=C.position.z;I.add(D)}function f(e){var t=d.projectVector((new THREE.Vector3).getPositionFromMatrix(e.matrixWorld),C);return t}function Q(e){e.preventDefault();v.x=e.clientX/window.innerWidth*2-1;v.y=-(e.clientY/window.innerHeight)*2+1}function X(e){e.preventDefault();for(var t=0;t<e.changedTouches.length;t++){var a=e.changedTouches[t].clientX/window.innerWidth*2-1;var r=-(e.changedTouches[t].clientY/window.innerHeight)*2+1;v.x=a;v.y=r}}function E(){requestAnimationFrame(E);h()}function h(){s=Date.now();n=s-l;l=s;if(isNaN(n)||n>1e3||n==0){n=1e3/60}var e=n/16;var t=Math.max(5,30/e);if(P.camera.type){C.position.x+=((v.x*1500+Math.sin(s*8e-4)*100)*P.mouse.sensivity-C.position.x)*P.mouse.speed/t;C.position.y+=((v.y*1500+Math.cos(s*6e-4)*100)*P.mouse.sensivity-C.position.y)*P.mouse.speed/t}else{B.x+=((v.x*1500+Math.sin(s*8e-4)*100)*P.mouse.sensivity-B.x)*P.mouse.speed/t;B.y+=((v.y*1500+Math.cos(s*6e-4)*100)*P.mouse.sensivity-B.y)*P.mouse.speed/t}C.lookAt(B);G.globalTime.value+=n*P.leaves.speed*5e-5;var a=f(W);V.uniforms["center"].value.x=(a.x+.5)*.8+.1;V.uniforms["center"].value.y=(a.y+.5)*.8+.1;j.uniforms["pos"].value.x=a.x;j.uniforms["pos"].value.y=a.y*-1;G.lightPos.value.x=a.x+.5;G.lightPos.value.y=a.y+.5;W.lookAt(C.position);var r=a.x*a.x+a.y*a.y;N.material.opacity=Math.max(.05,.2-r)-1+P.lensdirt.opacity;D.material.uniforms.globalTime.value+=n*P.fireflies.speed*5e-5;S.clear();for(var o=0;o<U.length;o++){if(U[o].light){U[o].material.materials[0].uniforms.lightPos.value.x=a.x+.5;U[o].material.materials[0].uniforms.lightPos.value.y=a.y+.5;U[o].material.materials[0].uniforms.globalTime.value+=n*.001}}G.black.value=0;W.visible=true;W.material.opacity=.8;S.render(I,C,L,true);G.black.value=1;W.material.opacity=.5;b.render(.01)}
	</script>
</body>

</html>